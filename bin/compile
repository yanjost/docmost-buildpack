#!/usr/bin/env bash
set -e
trap 'echo "[ERROR] $0 failed at line $LINENO: $BASH_COMMAND" >&2' ERR
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"
source "$SCRIPT_DIR/../lib/docmost_release.sh"
source "$SCRIPT_DIR/../lib/config_render.sh"
source "$SCRIPT_DIR/../lib/slugignore.sh"
source "$SCRIPT_DIR/../lib/size_analysis.sh"

# Load env vars from ENV_DIR
if [[ -d "$ENV_DIR" ]]; then
	for envfile in "$ENV_DIR"/*; do
		[ -f "$envfile" ] || continue
		varname=$(basename "$envfile")
		export "$varname"="$(cat "$envfile")"
	done
fi

step "Resolving Docmost version"
resolve_docmost_version

step "Fetching Docmost release tarball"
fetch_and_unpack_docmost

step "Inferring entrypoint"
infer_entrypoint

step "Configuring storage"
configure_storage

step "Configuring database and cache URLs"
configure_db_and_redis

step "Writing profile.d/10-docmost.sh"
write_profile_d

step "Configuring .slugignore for size optimization"
write_slugignore

step "Size Analysis" "Running size analysis (set DOCMOST_DEBUG_SIZE=true for details)"
analyze_slug_size

step "Compile finished"
