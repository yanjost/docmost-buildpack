#!/usr/bin/env bash
set -e
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"
source "$(dirname "$0")/../lib/common.sh"
source "$(dirname "$0")/../lib/docmost_release.sh"
source "$(dirname "$0")/../lib/config_render.sh"

# Load env vars from ENV_DIR
if [[ -d "$ENV_DIR" ]]; then
	for envfile in "$ENV_DIR"/*; do
		[ -f "$envfile" ] || continue
		varname=$(basename "$envfile")
		export "$varname"="$(cat "$envfile")"
	done
fi

step "Resolving Docmost version"
resolve_docmost_version

step "Fetching Docmost release tarball"
fetch_and_unpack_docmost

step "Inferring entrypoint"
infer_entrypoint

step "Configuring storage"
configure_storage

step "Configuring database and cache URLs"
configure_db_and_redis

step "Writing profile.d/10-docmost.sh"
write_profile_d

step "Compile finished"
